<?php 
require_once('civimobile.header.php');
require_once('initialise.php');
//Get the id from the URL
$path=$_SERVER['REQUEST_URI'];
$split = trim ( $path, "/" );
$split = explode ( "/" , $path );
array_pop($split);
$id = end($split);
//api call to get contact
$params = array ('version' =>'3',
				'contact_id' => $id
				);
$results=civicrm_api("Contact","get",$params );
?>

<div data-role="page">
  <div data-role="header">
    <h1>Edit contact</h1>
    <a href="#" id="save-contact-button" data-role="button" data-icon="check" class="ui-btn-right jqm-save">Save</a>
    <a href="#" id="back-contact-button"data-rel="back" class="ui-btn-left" data-icon="arrow-l">Back</a>
  </div><!-- /header -->

  <div data-role="content" id="edit-contact-fields">
  </div><!-- /content -->
  <?php require_once('civimobile.navbar.php') ?>
</div><!-- /page -->

<script>
var contactId = <?php echo $id; ?>;
var contact = <?php echo json_encode($results); ?>;
contact = contact.values[contactId];
console.log(contact);
var fieldIds = {};

$( function(){
  $('#save-contact-button').click(function(){ updateContact(); });
  createContactEditfields();
});

function createContactEditfields(){
  //this function gets all of the available contact fields in the profile
  var params = {};
  //get the profile fields
  $.getJSON("http://mobile.local/civicrm/profile/create?gid="+newIndividualProfileId+"&reset=1&json=1",
  {
    format: "json"
  },
  function(data) {
    jsonProfile = data
    //console.log(jsonProfile);
    $().crmAPI ('UFField','get',{'version' :'3', 'uf_group_id' : newIndividualProfileId}
    ,{ success:function (data){
      $.each(data.values, function(index, value) {
        //Logic to handle the difference between the field names generated by the API and JSON object, specifically with phone, email and address fields. 
        if (value.location_type_id){
          if (value.field_name.indexOf("phone") != -1){
            var field = jsonProfile[value.field_name+"-"+value.location_type_id+"-"+value.phone_type_id];
          }
          else{
            var field = jsonProfile[value.field_name+"-"+value.location_type_id];
          }
        }
        else if (value.field_name.indexOf("email") != -1){
          var field = jsonProfile[value.field_name+"-Primary"];
        }
        else if (value.field_name.indexOf("phone") != -1){
          var field = jsonProfile[value.field_name+"-Primary-"+value.phone_type_id];
        }
        else{
          var field = jsonProfile[value.field_name];
        }
        field = field.html;
        //build all fields from profile
        $('#edit-contact-fields').append('<div data-role="fieldcontain" class="ui-field-contain ui-body ui-br">'+field+'</div>');
        var id = $(field).attr('id');
        console.log(value);
        //         newid = id.split("-",[1]);
        //         $('#'+id).attr("id",newid);
        //         id = newid;
        //add the ids to the object for use when updating the contact values.
        fieldIds[id]="";
        $('#'+id).val(contact[value.field_name]);
        
        var tagName = $(field).get(0).tagName;
        //refresh the display after adding inputs and selects
        if (tagName == 'INPUT'){
          $('#'+id).textinput();
          $('#'+id).attr( 'placeholder', value.label )
        }
        if (tagName == 'SELECT'){
          $('#'+id).selectmenu();
          $('#'+id).parent().parent().prepend('<label for="'+id+'">'+value.label+':</label>');
        }
      });
    }
  });
});
}
function updateContact() {

  $.each(fieldIds, function(index, value) {
    fieldIds[index] = $('#'+index).val();
  });	
  fieldIds.version = "3";
  fieldIds.contact_type = "Individual";
  fieldIds.contact_id = contactId;
  fieldIds.profile_id = newIndividualProfileId;
  $().crmAPI ('Profile','set', fieldIds
  ,{ success:function (data){
    console.log(data)
    window.location.href = "/civimobile/contact/"+data.id+"/";
  }
  });
}
// function updateContact() {
// 
//   $.each(fieldIds, function(key, value) {
//     fieldIds[key] = $('#'+key).val();
//   });
//   fieldIds.id=contactId;
//   fieldIds.version=3;
//   console.log(fieldIds);
// 
//   $().crmAPI ('Contact','update',fieldIds
//   ,{ success:function (data){ 
//     window.location.href = "/civimobile/contact/"+data.id+"/";    
//   }
// });
// }
</script>
<?php require_once('civimobile.footer.php')?>