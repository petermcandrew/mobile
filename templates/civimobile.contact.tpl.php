<?php 
require_once('civimobile.header.php');
require_once('initialise.php');
//Get the id from the URL
$path=$_SERVER['REQUEST_URI'];
$split = trim ( $path, "/" );
$split = explode ( "/" , $path );
array_pop($split);
$id = end($split);
//api call to get contact
$params = array ('version' =>'3',
				'contact_id' => $id
				);
$results=civicrm_api("Contact","get",$params );
?>

<div data-role="page">
  <div data-role="header">
    <h1>Contact details</h1>
    <a href="edit" id="edit-contact-button" data-role="button" class="ui-btn-right jqm-edit" data-ajax="false">Edit</a>
    <a href="#" id="back-contact-button"data-rel="back" class="ui-btn-left" data-icon="arrow-l">Back</a>
  </div><!-- /header -->
  <div data-role="content" id="contact-details-content">
    <div class="content-primary">
      <ul data-role="listview" data-theme="g" data-inset="true" id="contact-details-sections" data-dividertheme="a">
      </ul>
    </div><!-- /content-primary -->
  </div><!-- /content -->
  <?php require_once('civimobile.navbar.php') ?>
</div><!-- /page -->


<script>
var contactId = <?php echo $id; ?>;
var contact = <?php echo json_encode($results); ?>;
contact = contact.values[contactId];
// console.log("contact");
// console.log(contact);


$( function(){
	$('#save-contact-button').click(function(){ updateContact(); });
	createContactfields();
	// $('#first_name').val(contact.values[contactId].first_name);
	//   $('#last_name').val(contact.values[contactId].last_name);
	//   $('#email').val(contact.values[contactId].email);
	//   $('#tel').val(contact.values[contactId].phone); 
});

function createContactfields(){
  //this function gets all of the available contact fields in the profile
  var params = {};
  var fieldIds = {};
  //get the profile fields
    var dataUrl = '<?php echo "{$civimobile_vars['civicrm_base']}/civicrm/profile/create?gid={$new_individual_profile_id}&reset=1&json=1"; ?>';  
    $.getJSON( dataUrl,
    {
      format: "json"
    },
    function(data) {
      jsonProfile = data
      //console.log(jsonProfile);
      $().crmAPI ('UFField','get',{'version' :'3', 'uf_group_id' : newIndividualProfileId}
      ,{ success:function (data){
        $.each(data.values, function(index, value) {
          //Logic to handle the difference between the field names generated by the API and JSON object, specifically with phone, email and address fields. 
          if (value.location_type_id){
            if (value.field_name.indexOf("phone") != -1){
              var field = jsonProfile[value.field_name+"-"+value.location_type_id+"-"+value.phone_type_id];
            }
            else{
              var field = jsonProfile[value.field_name+"-"+value.location_type_id];
            }
          }
          else if (value.field_name.indexOf("email") != -1){
            var field = jsonProfile[value.field_name+"-Primary"];
          }
          else if (value.field_name.indexOf("phone") != -1){
            var field = jsonProfile[value.field_name+"-Primary-"+value.phone_type_id];
          }
          else{
            var field = jsonProfile[value.field_name];
          }
          // console.log("value");
          //          console.log(value);
          field = field.html;
          
          //build all non blank sections
          if(contact[value.field_name]){
            $('#contact-details-sections').append('<li data-role="list-divider">'+value.label+'</li>');
            $('#contact-details-sections').append('<li role="option" tabindex="-1" data-theme="c" id="contact-'+value.field_name+'" >'+contact[value.field_name]+'</li>');
            var id = $(field).attr('id');
            //console.log("ID: "+id)
            var tagName = $(field).get(0).tagName;
            //refresh the display after adding inputs and selects
            if (tagName == 'INPUT'){
              $('#'+id).textinput();
              $('#'+id).attr( 'placeholder', value.label )
            }
            if (tagName == 'SELECT'){
              $('#'+id).selectmenu();
              $('#'+id).parent().parent().prepend('<label for="'+id+'">'+value.label+':</label>');
            }
          }
        });
        $("#contact-details-sections").listview('refresh');

      }
    });
  });
  //loop thorugh them adding the field name as a divider and the field value as a unlinked list item
  //decide what to do with fields that don't contain any values.
}


</script>

<?php require_once('civimobile.footer.php')?>
